const getArabicDayName = (date) => {
    const days = [
        'الأحد',
        'الاثنين',
        'الثلاثاء',
        'الأربعاء',
        'الخميس',
        'الجمعة',
        'السبت'
    ];
    return days[date.getDay()];
};

const App = {
    setup() {

        const state = Vue.reactive({
            number: '',
            commiteeDayName: '',   // ✅ جديد
            commiteeDate: '',
            committeeDesionNumber: '',
            committeeList: [],
            mappedItems: []
        });

        const services = {
            getPDFData: async (id) => {
                const res = await AxiosManager.get(
                    '/GoodsExamine/GetGoodsExamineSingle?id=' + id
                );

                console.log('API RESPONSE 👉', res);

                // ✅ المسار الصح
                return res.data.content;
            }
        };

        const methods = {
            loadData: async (id) => {
                const result = await services.getPDFData(id);

                const header = result.data;

                // ❗ ده الصح
                const transactions = result.purchaseOrder;


                state.number = header.number ?? '';
                if (header.commiteeDate) {
                    const d = new Date(header.commiteeDate);

                    state.commiteeDayName = getArabicDayName(d); // ✅ اليوم
                    state.commiteeDate = d.toLocaleDateString('ar-EG', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                } else {
                    state.commiteeDayName = '';
                    state.commiteeDate = '';
                }

                //state.commiteeDate = header.commiteeDate
                //    ? new Date(header.commiteeDate).toLocaleDateString('ar-EG')
                //    : '';

                state.committeeDesionNumber =
                    header.committeeDesionNumber ?? '';

                state.committeeList =
                    header.committeeList ?? [];

                state.mappedItems = (transactions ?? []).map(x => ({
                    product: `${x.product?.number ?? ''} - ${x.product?.name ?? ''}`,
                    qty: x.quantity ?? '',
                    unit: 'عدد',
                    matchPercent: x.percentage ?? '',
                    accepted: x.itemStatus === true,
                    rejected: x.itemStatus === false,
                    reason: x.reasons ?? ''
                }));

                console.log("daat", state.mappedItems)
            }
        };
        // ✅ رئيس اللجنة
        const chairman = Vue.computed(() =>
            state.committeeList.find(x => x.employeeType === true)
        );

        // ✅ أعضاء اللجنة
        const members = Vue.computed(() =>
            state.committeeList.filter(x => x.employeeType === false)
        );
        const handler = {
            downloadPDF: async () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');

                const pages = document.querySelectorAll('.print-area');

                for (let i = 0; i < pages.length; i++) {
                    const canvas = await html2canvas(pages[i], { scale: 2 });
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    if (i > 0) doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                }

                doc.save(`goods-examine-${state.number}.pdf`);
            }
        };

        Vue.onMounted(async () => {
            const id = new URLSearchParams(window.location.search).get('id');
            if (id) {
                await methods.loadData(id);
            }
        });

        // مهم جدًا
        return {
            state,
            chairman,
            members,
            handler
        };
    }
};

Vue.createApp(App).mount('#app');
